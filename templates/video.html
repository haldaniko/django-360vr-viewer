<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>360° DASH Video Player</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
    }

    header, footer {
      background: #222;
      color: #fff;
      padding: 20px;
      text-align: center;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      background: #111;
      color: #ccc;
    }

    #video360 {
      position: fixed;
      top: 0; left: 0;
      width: 1px; height: 1px;
      opacity: 0;
      pointer-events: none;
    }

    #player-container {
      width: 100%;
      max-width: 960px;
      height: 540px;
      margin: 40px 0;
      position: relative;
    }

    a-scene {
      width: 100%;
      height: 100%;
    }

    #playButton {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      padding: 12px 24px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 18px;
      cursor: pointer;
      border-radius: 6px;
      user-select: none;
      z-index: 10;
    }

    .text-block {
      max-width: 800px;
      margin: 20px auto;
      line-height: 1.6;
    }
  </style>
</head>
<body>

<header>
  <h1>360° VR Video Experience</h1>
</header>

<main>
  <div class="text-block">
    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis nec velit id leo ultrices pharetra. In feugiat, nulla at bibendum ullamcorper, justo diam convallis libero, sed bibendum enim purus ut ligula.</p>
  </div>

  <div id="player-container">
    <video id="video360" playsinline crossorigin="anonymous" webkit-playsinline muted></video>
    <a-scene vr-mode-ui="enabled: true" embedded>
      <a-videosphere id="videosphere" src="#video360" rotation="0 -90 0" visible="false"></a-videosphere>
      <a-camera look-controls="pointerLockEnabled: true" wasd-controls-enabled="false"></a-camera>
    </a-scene>
    <div id="playButton">Play</div>
  </div>

  <div class="text-block">
    <p>Curabitur vel mi vel sapien fermentum tempor. Suspendisse potenti. Nam nec purus nec sem blandit egestas nec ac lacus. Mauris in purus vel elit eleifend ultricies eget sit amet felis.</p>
  </div>
</main>

<footer>
  <p>&copy; 2025 VR Platform</p>
</footer>

<script>
  const video = document.getElementById('video360');
  const playButton = document.getElementById('playButton');
  const videosphere = document.getElementById('videosphere');
  const url = "{{ dash_manifest_url }}";

  const player = dashjs.MediaPlayer().create();

  player.updateSettings({
    streaming: {
      buffer: {
        stableBufferTime: 3,
        bufferTimeAtTopQuality: 5,
        bufferTimeAtTopQualityLongForm: 8,
        fastSwitchEnabled: true
      }
    }
  });

  player.initialize(video, url, false);

  player.on(dashjs.MediaPlayer.events.ERROR, (e) => {
    console.error('Dash.js error:', e);
    if (e.error && e.error.code === 'QuotaExceededError') {
      player.reset();
      player.initialize(video, url, false);
      video.pause();
      if (videosphere) videosphere.setAttribute('visible', 'false');
    }
  });

  video.addEventListener('loadeddata', () => {
    if (videosphere) videosphere.setAttribute('visible', 'true');
  });

  playButton.addEventListener('click', () => {
    player.play();
    video.muted = false;
    video.play().catch(e => console.error('Video play failed:', e));
    playButton.style.display = 'none';
  });
</script>

</body>
</html>
